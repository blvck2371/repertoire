name: CD

on:
  push:
    branches: [develop, preprod, prod]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: |
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "tag=dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/preprod" ]; then
            echo "tag=preprod" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/prod" ]; then
            VERSION=$(node -p "require('./package.json').version")
            echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          load: true
          tags: repertoire-backend:${{ steps.tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          load: true
          tags: repertoire-frontend:${{ steps.tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  push-registry:
    runs-on: ubuntu-latest
    needs: build
    if: vars.ENABLE_HARBOR == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: |
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "tag=dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/preprod" ]; then
            echo "tag=preprod" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Set registry domain
        id: registry
        run: |
          # DigitalOcean: registry.digitalocean.com/repertoire-registry
          # Harbor: harbor.example.com
          # On extrait le domaine pour le login (partie avant le premier /)
          REGISTRY_URL="${{ secrets.HARBOR_URL }}"
          REGISTRY_DOMAIN=$(echo "$REGISTRY_URL" | cut -d'/' -f1)
          echo "domain=$REGISTRY_DOMAIN" >> $GITHUB_OUTPUT
          echo "full=$REGISTRY_URL" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.registry.outputs.domain }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.registry.outputs.full }}/backend:${{ steps.tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.registry.outputs.full }}/frontend:${{ steps.tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-k8s:
    runs-on: ubuntu-latest
    needs: build
    if: vars.ENABLE_KUBERNETES == 'true'
    environment:
      name: ${{ github.ref == 'refs/heads/prod' && 'production' || (github.ref == 'refs/heads/preprod' && 'preprod' || 'development') }}

    steps:
      - uses: actions/checkout@v4

      - name: Set namespace
        id: ns
        run: |
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "namespace=dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/preprod" ]; then
            echo "namespace=preprod" >> $GITHUB_OUTPUT
          else
            echo "namespace=prod" >> $GITHUB_OUTPUT
          fi

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Deploy placeholder
        run: |
          echo "âœ… kubectl configurÃ© pour le namespace ${{ steps.ns.outputs.namespace }}"
          echo "ðŸ“‹ Ajoutez vos manifests Kubernetes (Phase 5) pour le dÃ©ploiement complet."
