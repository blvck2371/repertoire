# Overlay Vault - à utiliser avec : docker compose -f docker-compose.prod.yml -f docker-compose.vault.yml up -d
# Stocke les secrets (MONGODB_URI) dans Vault, le backend les récupère au démarrage

services:
  vault:
    image: hashicorp/vault:1.15
    container_name: repertoire-vault
    ports:
      - "127.0.0.1:8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    command: server -dev
    cap_add:
      - IPC_LOCK
    healthcheck:
      disable: true
    restart: unless-stopped

  vault-init:
    image: alpine:3.19
    container_name: repertoire-vault-init
    depends_on:
      vault:
        condition: service_started
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      MONGODB_URI: mongodb://mongodb:27017/repertoire
    volumes:
      - ./scripts/vault-init.sh:/vault-init.sh
    entrypoint: ["/bin/sh", "/vault-init.sh"]
    restart: "no"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.vault
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      PORT: 3001
    depends_on:
      vault-init:
        condition: service_completed_successfully
      mongodb:
        condition: service_started
