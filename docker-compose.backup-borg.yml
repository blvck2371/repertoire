# Backup BorgBackup + DigitalOcean Spaces (chiffré, versionné)
# Usage: docker compose -f docker-compose.prod.yml -f docker-compose.backup-borg.yml run --rm backup-borg
# Cron prod (quotidien): 0 2 * * *
# Cron dev (hebdo): 0 2 * * 0

services:
  backup-borg:
    build:
      context: ./scripts
      dockerfile: Dockerfile.backup-borg
    image: repertoire-backup-borg:latest
    container_name: repertoire-backup-borg
    depends_on:
      - mongodb
    environment:
      BACKUP_DIR: /backups
      # Borg (obligatoire)
      BORG_PASSPHRASE: ${BORG_PASSPHRASE}
      # DigitalOcean Spaces
      SPACES_KEY: ${SPACES_KEY}
      SPACES_SECRET: ${SPACES_SECRET}
      SPACES_BUCKET: ${SPACES_BUCKET}
      SPACES_REGION: ${SPACES_REGION:-nyc3}
      # Environnement (prod=quotidien, dev=hebdo)
      BACKUP_ENV: ${BACKUP_ENV:-prod}
    volumes:
      - backup_borg_data:/backups
    restart: "no"
    profiles:
      - backup-borg

volumes:
  backup_borg_data:
