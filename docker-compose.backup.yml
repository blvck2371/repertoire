# Overlay Backup - exécution : docker compose -f docker-compose.prod.yml -f docker-compose.backup.yml run --rm backup
# Avec S3 : définir S3_ENABLED=true, S3_BUCKET, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
# Avec MinIO : ajouter AWS_ENDPOINT_URL=http://minio:9000

services:
  backup:
    build:
      context: ./scripts
      dockerfile: Dockerfile.backup
    image: repertoire-backup:latest
    container_name: repertoire-backup
    depends_on:
      - mongodb
    environment:
      BACKUP_DIR: /backups
      # S3/MinIO (optionnel)
      S3_ENABLED: ${S3_ENABLED:-false}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_PREFIX: ${S3_PREFIX:-backups}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-us-east-1}
      AWS_ENDPOINT_URL: ${AWS_ENDPOINT_URL:-}
    volumes:
      - backup_data:/backups
    restart: "no"
    profiles:
      - backup

volumes:
  backup_data:
